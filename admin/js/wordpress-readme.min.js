const marked=require("marked"),fs=require("fs"),readmeData={contributors:"dmitryrudakov",tags:"gutenberg, folders, dominant color, admin, media library folders, media library",tested:"5.6.2",license:"GPLv2 or later"},skipTokens=[{type:"html",contains:!0},{type:"blockquote",contains:"&#x1F383;"},{type:"paragraph",contains:"img.shields.io"},{type:"paragraph",contains:"user-images.githubusercontent.com"}],skipSections=["Download","Public API methods"],skipLogs=["(-)","[-]"],options={main:"zu-media.php",from:"README.md",to:"readme.txt",log:"CHANGES.md",limitRecordrs:15};function readFileAndSaveResult(){const e=parseReadme(fs.readFileSync(options.from).toString()),t=parseChangelog(fs.readFileSync(options.log).toString(),options.limitRecordrs),n=String(e+"\n\n== Changelog ==\n\n"+t).replace(/\n{3,}/g,"\n\n");fs.writeFileSync(options.to,n)}function parseReadme(e){const t=marked.lexer(e);let n=[],s={enabled:!1,depth:0},i=0;return t.forEach((e=>{const t=skipTokens.reduce(((t,n)=>!0===t||void 0===n?t:!(e.type!==n.type||!0!==n.contains&&!e.raw.includes(n.contains))),!1);if("heading"===e.type&&(s.enabled?e.depth===s.depth&&(s.enabled=!1):skipSections.forEach((t=>{e.raw.includes(t)&&(s.enabled=!0,s.depth=e.depth)}))),!t&&!s.enabled){if("heading"===e.type){if(1===e.depth){const t=e.text.split(":")[0]||e.text;return void n.push(`=== ${t.trim()} ===${parseHeader(readmeData)}\n\n`)}if(2===e.depth){if(e.raw.includes("[![")){let t=null;try{t=e.tokens[0].tokens[0].text}catch(e){}t&&n.push(`${++i}. ${t}\n`)}else n.push(`== ${e.text} ==\n\n`);return}}n.push(e.raw)}})),n.join("")}function parseChangelog(e,t){const n=marked.lexer(e);let s=[],i=0;return n.forEach((e=>{if(!(i>t))if("heading"!==e.type||4!==e.depth)"list"===e.type&&(e.items.forEach((e=>{skipLogs.reduce(((t,n)=>!0===t||void 0===n?t:!!e.text.endsWith(n)),!1)||s.push(e.raw)})),i++);else{const t=e.text.split("/")[0]||e.text;s.push(`\n### ${t.trim()} ###\n`)}})),s.join("")}function parseHeader(e){const t=fs.readFileSync(options.main).toString(),n=/Version\s*:\s*([^\s]+)/gm.exec(t);e.stable=null!==n?n[1]:"1.0.0";const s=/Requires at least\s*:\s*([^\s]+)/gm.exec(t);e.requires=null!==s?s[1]:"5.1";const i=/Requires PHP\s*:\s*([^\s]+)/gm.exec(t);return e.php=null!==i?i[1]:"7.0",`\nContributors: ${e.contributors}\nTags: ${e.tags}\nRequires at least: ${e.requires}\nTested up to: ${e.tested}\nStable tag: ${e.stable}\nLicense: ${e.license}\nRequires PHP: ${e.php}`}readFileAndSaveResult();